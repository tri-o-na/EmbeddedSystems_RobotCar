<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Car Obstacle Avoidance Dashboard</title>
    <link rel="stylesheet" href="dashboard.css">
    <script src="https://unpkg.com/mqtt@5/dist/mqtt.min.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>ü§ñ Robot Car Obstacle Avoidance Dashboard</h1>
            <div class="connection-status" id="connectionStatus">
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">Disconnected</span>
            </div>
        </header>

        <div class="dashboard-grid">
            <!-- Distance Monitoring Section -->
            <section class="telemetry-panel">
                <h2>üìè Distance Monitoring</h2>
                <div class="telemetry-data">
                    <div class="data-item large-value">
                        <label>Current Distance:</label>
                        <span id="currentDistance" class="distance-value">-- cm</span>
                    </div>
                    <div class="data-item">
                        <label>Detection Range:</label>
                        <span>45.0 cm</span>
                    </div>
                    <div class="data-item">
                        <label>Status:</label>
                        <span id="robotStatus" class="status-text">Monitoring</span>
                    </div>
                </div>
                <div class="last-update">
                    Last update: <span id="lastDistanceUpdate">Never</span>
                </div>
            </section>

            <!-- Obstacle Detection Section -->
            <section class="obstacle-panel">
                <h2>üöß Obstacle Analysis</h2>
                <div class="obstacle-data">
                    <div class="obstacle-side">
                        <h3>‚¨ÖÔ∏è LEFT Side</h3>
                        <div class="data-item">
                            <label>Width:</label>
                            <span id="leftWidth">-- cm</span>
                        </div>
                        <div class="data-item">
                            <label>Clear Positions:</label>
                            <span id="leftClear">--</span>
                        </div>
                        <div class="data-item">
                            <label>Detections:</label>
                            <span id="leftDetections">--</span>
                        </div>
                        <div class="data-item">
                            <label>Avg Distance:</label>
                            <span id="leftAvgDist">-- cm</span>
                        </div>
                    </div>
                    
                    <div class="decision-center">
                        <div class="decision-result" id="decisionResult">
                            <div class="decision-text">Waiting...</div>
                        </div>
                        <div class="decision-reason" id="decisionReason">--</div>
                    </div>

                    <div class="obstacle-side">
                        <h3>‚û°Ô∏è RIGHT Side</h3>
                        <div class="data-item">
                            <label>Width:</label>
                            <span id="rightWidth">-- cm</span>
                        </div>
                        <div class="data-item">
                            <label>Clear Positions:</label>
                            <span id="rightClear">--</span>
                        </div>
                        <div class="data-item">
                            <label>Detections:</label>
                            <span id="rightDetections">--</span>
                        </div>
                        <div class="data-item">
                            <label>Avg Distance:</label>
                            <span id="rightAvgDist">-- cm</span>
                        </div>
                    </div>
                </div>
                <div class="last-update">
                    Last obstacle: <span id="lastObstacleUpdate">Never</span>
                </div>
            </section>

            <!-- Scan Results Section -->
            <section class="scan-panel">
                <h2>üîç Real-time Scan Data</h2>
                <div class="scan-log" id="scanLog">
                    <div class="log-entry">Waiting for scan data...</div>
                </div>
                <button onclick="clearScanLog()" class="btn-clear">Clear Log</button>
            </section>

            <!-- Motor Control Section -->
            <section class="control-panel">
                <h2>üéÆ Robot Control</h2>
                <div class="control-group">
                    <label for="motor1Slider">Motor 1: <span id="motor1Value">0.00</span></label>
                    <input type="range" id="motor1Slider" min="-1" max="1" step="0.01" value="0"
                        oninput="updateMotorDisplay(1, this.value)">
                </div>

                <div class="control-group">
                    <label for="motor2Slider">Motor 2: <span id="motor2Value">0.00</span></label>
                    <input type="range" id="motor2Slider" min="-1" max="1" step="0.01" value="0"
                        oninput="updateMotorDisplay(2, this.value)">
                </div>

                <div class="button-group">
                    <button onclick="sendStop()" class="btn-stop">üõë Emergency Stop</button>
                    <button onclick="sendZero()" class="btn-zero">0Ô∏è‚É£ Set to Zero</button>
                </div>

                <div class="command-status" id="commandStatus"></div>
            </section>
        </div>

        <!-- Statistics Section -->
        <section class="stats-panel">
            <h2>üìä Session Statistics</h2>
            <div class="stats-data">
                <div class="stat-item">
                    <label>Total Obstacles:</label>
                    <span id="totalObstacles">0</span>
                </div>
                <div class="stat-item">
                    <label>Left Bypasses:</label>
                    <span id="leftBypasses">0</span>
                </div>
                <div class="stat-item">
                    <label>Right Bypasses:</label>
                    <span id="rightBypasses">0</span>
                </div>
                <div class="stat-item">
                    <label>Avg Obstacle Distance:</label>
                    <span id="avgObstacleDistance">-- cm</span>
                </div>
            </div>
        </section>

        <!-- Configuration Section -->
        <section class="config-panel">
            <h2>‚öôÔ∏è MQTT Configuration</h2>
            <div class="config-container">
                <div class="config-inputs">
                    <div class="input-group">
                        <label for="brokerIP">Broker IP Address</label>
                        <input type="text" id="brokerIP" value="172.20.10.3" placeholder="172.20.10.3">
                    </div>
                    <div class="input-group">
                        <label for="brokerPort">Broker Port</label>
                        <input type="number" id="brokerPort" value="9001" placeholder="9001">
                    </div>
                    <div class="connect-button-wrapper">
                        <button onclick="connectMQTT()" id="connectBtn" class="btn-connect">Connect to Broker</button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        let client = null;
        let stats = {
            totalObstacles: 0,
            leftBypasses: 0,
            rightBypasses: 0,
            obstacleDistances: []
        };

        function connectMQTT() {
            const brokerIP = document.getElementById('brokerIP').value;
            const brokerPort = document.getElementById('brokerPort').value;
            const clientId = 'dashboard_' + Math.random().toString(16).substr(2, 8);
            
            const url = `ws://${brokerIP}:${brokerPort}`;
            
            try {
                client = mqtt.connect(url, {
                    clientId: clientId,
                    keepalive: 60,
                    clean: true
                });

                client.on('connect', function () {
                    updateConnectionStatus(true);
                    console.log('Connected to MQTT broker');
                    
                    // Subscribe to all telemetry topics
                    client.subscribe('telemetry/distance');
                    client.subscribe('telemetry/obstacle'); 
                    client.subscribe('telemetry/scan');
                    client.subscribe('test/robot');
                    
                    addScanLogEntry('üì° Connected to MQTT broker - listening for robot data');
                });

                client.on('message', function (topic, message) {
                    try {
                        const data = JSON.parse(message.toString());
                        handleMQTTMessage(topic, data);
                    } catch (e) {
                        console.error('Error parsing MQTT message:', e);
                        addScanLogEntry(`‚ùå Error parsing message from ${topic}`);
                    }
                });

                client.on('error', function (error) {
                    console.error('MQTT Error:', error);
                    updateConnectionStatus(false);
                    addScanLogEntry('‚ùå MQTT Connection error');
                });

                client.on('close', function () {
                    updateConnectionStatus(false);
                    addScanLogEntry('üîå MQTT Connection closed');
                });

            } catch (error) {
                console.error('Connection error:', error);
                updateConnectionStatus(false);
            }
        }

        function handleMQTTMessage(topic, data) {
            const now = new Date().toLocaleTimeString();
            
            switch(topic) {
                case 'telemetry/distance':
                    updateDistanceData(data, now);
                    break;
                    
                case 'telemetry/obstacle':
                    updateObstacleData(data, now);
                    updateStats(data);
                    break;
                    
                case 'telemetry/scan':
                    updateScanData(data, now);
                    break;
                    
                case 'test/robot':
                    addScanLogEntry(`üîß Test message: ${JSON.stringify(data)}`);
                    break;
            }
        }

        function updateDistanceData(data, timestamp) {
            document.getElementById('currentDistance').textContent = `${data.distance} cm`;
            document.getElementById('lastDistanceUpdate').textContent = timestamp;
            
            // Update robot status based on distance
            const status = document.getElementById('robotStatus');
            if (data.distance <= 45.0) {
                status.textContent = 'üö® Obstacle Detected';
                status.className = 'status-text alert';
            } else {
                status.textContent = '‚úÖ Path Clear';
                status.className = 'status-text normal';
            }
        }

        function updateObstacleData(data, timestamp) {
            // Update obstacle width data
            document.getElementById('leftWidth').textContent = data.left_width > 0 ? `${data.left_width.toFixed(1)} cm` : '--';
            document.getElementById('rightWidth').textContent = data.right_width > 0 ? `${data.right_width.toFixed(1)} cm` : '--';
            document.getElementById('leftClear').textContent = data.left_clear || '--';
            document.getElementById('rightClear').textContent = data.right_clear || '--';
            
            // Update decision display
            const decisionResult = document.getElementById('decisionResult');
            const decisionReason = document.getElementById('decisionReason');
            
            if (data.decision === 'LEFT') {
                decisionResult.innerHTML = '<div class="decision-text left">‚¨ÖÔ∏è BYPASS LEFT</div>';
                decisionResult.className = 'decision-result left';
            } else {
                decisionResult.innerHTML = '<div class="decision-text right">‚û°Ô∏è BYPASS RIGHT</div>';
                decisionResult.className = 'decision-result right';
            }
            
            decisionReason.textContent = data.reason || '--';
            document.getElementById('lastObstacleUpdate').textContent = timestamp;
            
            // Add to scan log
            addScanLogEntry(`üöß Obstacle at ${data.distance}cm - Decision: ${data.decision} (${data.reason})`);
        }

        function updateScanData(data, timestamp) {
            const side = data.side;
            const prefix = side.toLowerCase();
            
            // Update scan-specific data
            document.getElementById(`${prefix}Detections`).textContent = data.detections || '--';
            document.getElementById(`${prefix}AvgDist`).textContent = 
                data.avg_dist > 0 ? `${data.avg_dist.toFixed(1)} cm` : '--';
            
            // Add detailed scan log entry
            addScanLogEntry(
                `üîç ${side} scan: ${data.detections} detections, ` +
                `${data.clear_count} clear, width: ${data.width?.toFixed(1) || '--'} cm`
            );
        }

        function updateStats(data) {
            stats.totalObstacles++;
            stats.obstacleDistances.push(data.distance);
            
            if (data.decision === 'LEFT') {
                stats.leftBypasses++;
            } else {
                stats.rightBypasses++;
            }
            
            // Update display
            document.getElementById('totalObstacles').textContent = stats.totalObstacles;
            document.getElementById('leftBypasses').textContent = stats.leftBypasses;
            document.getElementById('rightBypasses').textContent = stats.rightBypasses;
            
            const avgDistance = stats.obstacleDistances.reduce((a, b) => a + b, 0) / stats.obstacleDistances.length;
            document.getElementById('avgObstacleDistance').textContent = `${avgDistance.toFixed(1)} cm`;
        }

        function addScanLogEntry(message) {
            const scanLog = document.getElementById('scanLog');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="timestamp">${timestamp}</span> ${message}`;
            
            scanLog.insertBefore(entry, scanLog.firstChild);
            
            // Keep only last 20 entries
            while (scanLog.children.length > 20) {
                scanLog.removeChild(scanLog.lastChild);
            }
        }

        function clearScanLog() {
            document.getElementById('scanLog').innerHTML = '<div class="log-entry">Log cleared</div>';
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            const btn = document.getElementById('connectBtn');
            
            if (connected) {
                indicator.className = 'status-indicator connected';
                text.textContent = 'Connected';
                btn.textContent = 'Connected';
                btn.disabled = true;
            } else {
                indicator.className = 'status-indicator disconnected';
                text.textContent = 'Disconnected';
                btn.textContent = 'Connect to Broker';
                btn.disabled = false;
            }
        }

        // Motor control functions (keeping your existing functionality)
        function updateMotorDisplay(motor, value) {
            document.getElementById(`motor${motor}Value`).textContent = parseFloat(value).toFixed(2);
        }

        function sendStop() {
            if (client && client.connected) {
                client.publish('robot/commands', JSON.stringify({command: 'stop'}));
                document.getElementById('commandStatus').textContent = 'Emergency stop sent!';
            }
        }

        function sendZero() {
            if (client && client.connected) {
                client.publish('robot/commands', JSON.stringify({command: 'zero'}));
                document.getElementById('commandStatus').textContent = 'Motors set to zero!';
            }
        }

        // Auto-connect on page load
        window.onload = function() {
            // You can auto-connect here if desired
            // connectMQTT();
        };
    </script>

    <style>
        /* Additional styles for the new elements */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .obstacle-panel {
            grid-column: span 2;
        }

        .obstacle-data {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: start;
        }

        .decision-center {
            text-align: center;
            padding: 20px;
        }

        .decision-result {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .decision-result.left {
            background: linear-gradient(45deg, #4CAF50, #66BB6A);
            color: white;
        }

        .decision-result.right {
            background: linear-gradient(45deg, #2196F3, #42A5F5);
            color: white;
        }

        .distance-value {
            font-size: 2em;
            font-weight: bold;
            color: #2196F3;
        }

        .status-text.alert {
            color: #f44336;
            font-weight: bold;
        }

        .status-text.normal {
            color: #4CAF50;
            font-weight: bold;
        }

        .scan-log {
            background: #f5f5f5;
            border-radius: 5px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
            border-bottom: 1px solid #eee;
        }

        .timestamp {
            color: #666;
            font-size: 0.8em;
        }

        .stats-panel {
            grid-column: span 2;
        }

        .stats-data {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 8px;
        }

        .btn-clear {
            margin-top: 10px;
            padding: 5px 15px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</body>

</html>